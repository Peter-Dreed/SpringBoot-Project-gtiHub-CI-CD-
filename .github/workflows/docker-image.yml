name: Full Self-Hosted Terraform CI/CD

on:
  push:
    paths:
      - 'spring-boot-demo/**'
  workflow_dispatch:
    inputs:
      action:
        description: "Select Terraform action (only applies when manually triggered)"
        required: true
        default: "apply"
        type: choice
        options:
          - apply
          - destroy

jobs:
  ci-cd:
    runs-on: self-hosted

    steps:
    - name: ğŸ”„ Checkout Code
      uses: actions/checkout@v3

    - name: â˜• Set up Java 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ”¨ Build Spring Boot App
      working-directory: ./spring-boot-demo
      run: mvn clean package -DskipTests

    - name: ğŸ” Docker Login
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: ğŸ³ Build Docker Image
      working-directory: ./spring-boot-demo
      run: docker build -t ${{ secrets.DOCKER_USERNAME }}/springboot-demo .

    - name: ğŸš€ Push Docker Image
      run: docker push ${{ secrets.DOCKER_USERNAME }}/springboot-demo

    - name: ğŸ“¦ Terraform Init
      working-directory: ./terraform/environment/dev
      run: terraform init

    - name: ğŸ” Terraform Plan & Apply or Destroy
      working-directory: ./terraform/environment/dev
      run: |
        ACTION="${{ github.event.inputs.action || 'apply' }}"

        if [[ "$ACTION" == "apply" ]]; then
          echo "ğŸ’  Taint container to force recreation (if exists)..."
          terraform taint docker_container.springboot_container || true
          echo "ğŸ§  Planning infrastructure..."
          terraform plan -out=tfplan
          echo "ğŸš€ Applying plan..."
          terraform apply -auto-approve tfplan
        else
          echo "ğŸ’£ Destroying infrastructure..."
          terraform destroy -auto-approve
        fi
